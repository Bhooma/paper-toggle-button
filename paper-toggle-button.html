<!--
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<!--
`paper-checkbox` is a button that can be either checked or unchecked.  User
can tap the checkbox to check or uncheck it.  Usually you use checkboxes
to allow user to select multiple options from a set.  If you have a single
ON/OFF option, avoid using a single checkbox and use `paper-toggle-button`
instead.

Example:

    <paper-toggle-button></paper-checkbox>


Styling toggle-button:
  <style is="x-style">
    * {
      --paper-toggle-button-unchecked-bar-color: #FF4081;
      --paper-toggle-button-unchecked-button-color: #9c27b0;
      --paper-toggle-button-unchecked-ink-color: #009688;

      --paper-toggle-button-checked-bar-color: #5677fc;
      --paper-toggle-button-checked-button-color: #ff4081;
      --paper-toggle-button-checked-ink-color: #ff4081;
    }
  </style>

@group Paper Elements
@class paper-toggle-button
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-ripple/paper-ripple.html">

/* TODO: This needs to use core-focusable when it's ready. */
<dom-module id="paper-toggle-button">
  <style is="x-style">
    * {
      --paper-toggle-button-unchecked-bar-color: #000000;
      --paper-toggle-button-unchecked-button-color: #f1f1f1;
      --paper-toggle-button-unchecked-ink-color: #bbb;

      --paper-toggle-button-checked-bar-color: #0f9d58;
      --paper-toggle-button-checked-button-color: #0f9d58;
      --paper-toggle-button-checked-ink-color: #0f9d58;
    }
  </style>

  <link rel="import" type="css" href="paper-toggle-button.css">

  <template>

    <div id="toggleContainer">
      <div id="toggleBar" class="toggle-bar"></div>
      <div id="toggleButton" class="toggle-button">
        <paper-ripple id="ink" class="toggle-ink circle" recenters></paper-ripple>
      </div>
    </div>
  </template>

</dom-module>

<script>
  Polymer({
    is: 'paper-toggle-button',

    // The custom properties shim is currently an opt-in feature.
    enableCustomStyleProperties: true,

    hostAttributes: {
      role: 'button',
      'aria-pressed': false,
      tabindex: 0
    },

    properties: {
      /**
       * Fired when the checked state changes due to user interaction.
       *
       * @event change
       */

      /**
       * Fired when the checked state changes.
       *
       * @event core-change
       */

      /**
       * Gets or sets the state, `true` is checked and `false` is unchecked.
       *
       * @attribute checked
       * @type boolean
       * @default false
       */
      checked: {
        type: Boolean,
        value: false,
        reflectToAttribute: true,
        observer: 'checkedChanged'
      },

      /**
       * If true, the user cannot interact with this element.
       *
       * @attribute disabled
       * @type boolean
       * @default false
       */
      disabled: {
        type: Boolean
      }
    },

    listeners: {
      keydown: 'onKeyDown',
      mousedown: 'onMouseDown',
      mouseup: 'onMouseUp',
      tap: 'onTap',
      track: 'onTrack'
    },

    onKeyDown: function(event) {
      // Enter key.
      if (event.keyCode === 13) {
        this.onTap();
        event.preventDefault();
      }
    },

    onMouseDown: function(e) {
      console.log("onMouseDown", this.checked);

      var rect = this.$.ink.getBoundingClientRect();
      this.$.ink.mousedownAction({x: rect.left + rect.width / 2,
      y: rect.top + rect.height / 2});
    },

    onMouseUp: function(e) {
      console.log("onMouseUp", this.checked);

      this.$.ink.mouseupAction();
    },

    onTap: function() {
      console.log("onTap");
      if (this.disabled) {
        return;
      }
      this.checked = !this.checked;
      this.fire('change');
    },

    onTrack: function(event) {
      if (this.disabled) {
        return;
      }

      if (event.detail.state === 'start' ) {
        console.log("onTrackStart");


        this._w = this.$.toggleBar.offsetWidth / 2;
        this._startx = event.detail.x;
        //e.preventTap();
      } else if (event.detail.state === 'end' ) {
        console.log("onTrackEnd");


        var s =  this.$.toggleButton.style;
        s.transform = s.webkitTransform = '';
        this.$.toggleButton.classList.remove('dragging');
        var old = this.checked;
        this.checked = Math.abs(this._x) > this._w / 2;
        if (this.checked !== old) {
          this.fire('change');
        }

      } else if (event.detail.state === 'move' ){
        var dx = event.detail.x - this._startx;
        this._x = Math.min(this._w,
            Math.max(0, this.checked ? this._w + dx : dx));

        this.$.toggleButton.classList.add('dragging');
        var s =  this.$.toggleButton.style;
        s.webkitTransform = s.transform = 'translate3d(' + this._x + 'px,0,0)';
      }
    },

    checkedChanged: function() {
      this.setAttribute('aria-pressed', this.checked ? 'true' : 'false');
      this.fire('core-change');
    }
  })
</script>
